{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "description": [
    " This preset provides a shared configuration for updating GitHub Actions. It adds a custom",
    " manager to handle action dependencies in selected repositories and includes general policy",
    " rules (such as digest pinning behavior). It also extends presets that map digests to semver",
    " versions"
  ],
  "extends": [
    "group:githubArtifactActions",
    "helpers:pinGitHubActionDigestsToSemver",
    "Kong/public-shared-renovate:github-actions-changed-files"
  ],
  "customManagers": [
    {
      "description": [
        " Custom regex manager for sub-actions under 'Kong/public-shared-actions/**'. It operates",
        " in workflow/action YAML files such as:",
        "   - .github/workflows/*.yml",
        "   - workflow-templates/**",
        "   - action.yml",
        "",
        " Matching behavior",
        "   - Matches fully qualified action paths with any number of nested subpaths ending in",
        "     '@<ref>'",
        "   - <ref> can be a semver-like tag ('v1.2.3', '1.2.3', '7.8.9.10', 'v0.1.2-abc') or a",
        "     commit SHA (7-40 hex chars) used as a digest",
        "   - If pinned by digest, an optional inline comment may include the human-readable",
        "     version; whitespace before/after '#' is allowed. Examples: '# v1.2.3', '# 1.2.3',",
        "     or '#1.2.3'",
        "   - Versions support 1–4 numeric sections and optional prerelease/build parts with",
        "     hyphens/dots; an optional leading 'v' is allowed",
        "",
        " Version extraction (extractVersionTemplate) - examples",
        "   - @security-actions/sca@1.2.3",
        "   - @security-actions/scan-rust@v4.5.6",
        "   - security-actions/semgrep@7.8.9.10",
        "   - security-actions/lua-lint@v0.1.2-abc",
        "   - sca@7.8.9",
        "   - scan-rust@v0.1.2",
        "   - a/b/c/d/e/lua-lint@v3.4.5.6-abc.foo",
        "",
        " matchStrings - examples of full matches",
        "   # VALID",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3.4 # foo",
        "   - Kong/public-shared-actions/security-actions/sca@v1.2.3-abcd-a # bar",
        "   - Kong/public-shared-actions/a/b/c/d/e/f/sca@0928c369d5227de0ca35643d0e86949114384bd2",
        "   - Kong/public-shared-actions/sca@0928c369d5227de0ca35643d0e86949114384bd2 # v1.2.3",
        "   - Kong/public-shared-actions/sca@0928c36\t \t#\t\t 1.2.3",
        "   - Kong/public-shared-actions/sca@0928c369d#1.2.3",
        "",
        "   # INVALID",
        "   - foo/public-shared-actions/security-actions/sca@1.2.3",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3.4.5 # foo",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3_abcd-a # bar",
        "   - Kong/public-shared-actions/security-actions/sca@b1.2.3-abcd-a # bar",
        "   - Kong/public-shared-actions/a/b/c/d/e/f/g/1h/sca@0928c",
        "   - Kong/public-shared-actions/sca@0928c369d5227de0ca35643d0e86949114384bd2foo # v1.2.3",
        "   - Kong/public-shared-actions/sca@0928c36_2\t \t#\t\t 1.2.3",
        "   - Kong/public-shared-actions/sca@0928c369d5227de0ca35643d0e86949114384bd2##1.2.3",
        "",
        " Version lookup and replacement",
        "   - 'datasourceTemplate': Uses GitHub tags to find available releases for the action.",
        "     Renovate queries the 'Kong/public-shared-actions' repository's tags and, under",
        "     semver-coerced versioning, applies SemVer sorting after coercing tag names.",
        "     Updates track published tags like 'sca@1.2.3' rather than branches or release",
        "     assets",
        "   - 'autoReplaceStringTemplate': Defines how the matched reference is rewritten.",
        "     It keeps the full package path ('{{{packageName}}}') and replaces the '@<ref>' with:",
        "       - '@<newDigest> # v<newVersion>' when pinning by commit (adds a friendly version)",
        "       - '@<newVersion>'                when referencing by tag only",
        "     Examples:",
        "       - '@0928… # v1.2.3' -> '@abcd… # v1.2.4'",
        "       - '@1.2.3'          -> '@1.2.4'"
      ],
      "customType": "regex",
      "managerFilePatterns": [
        "/(^|/)(workflow-templates|\\.(?:github|gitea|forgejo)/(?:workflows|actions))/.+\\.ya?ml$/",
        "/(^|/)action\\.ya?ml$/"
      ],
      "matchStrings": [
        "(?<packageName>Kong/public-shared-actions/(?:[0-9A-Za-z._-]*/)*(?<depName>[^\\s@]+))@(?:(?<currentDigest>[0-9A-Fa-f]{7,40})[\\t ]*#[\\t ]*)?v?(?<currentValue>[0-9]*(?:\\.[0-9]+){0,3}(?:-[0-9A-Za-z.-]+)?)(?<indentation>\\s|$)"
      ],
      "datasourceTemplate": "github-tags",
      "extractVersionTemplate": "^@?(?:[0-9A-Za-z._-]*/)*{{{depName}}}[@_]v?(?<version>[0-9]+(?:\\.[0-9]+){0,3}(?:-[0-9A-Za-z.-]+)?)$",
      "autoReplaceStringTemplate": "{{{packageName}}}@{{#if newDigest}}{{{newDigest}}} # v{{/if}}{{{newValue}}}{{{indentation}}}"
    }
  ],
  "packageRules": [
    {
      "description": [
        " Manage Kong/public-shared-actions updates using the custom manager, so disable the default",
        " GitHub Actions manager for these"
      ],
      "matchPackageNames": ["Kong/public-shared-actions"],
      "matchManagers": ["github-actions"],
      "enabled": false
    },
    {
      "description": [
        " Group and pin updates for public-shared-actions discovered by this custom manager",
        " - Grouping switched from depName to packageName, so each PR groups by the full action",
        "   path",
        " - pinDigests enabled to always pin sub-action references to a commit SHA for security",
        "   and stable tracking",
        " - groupName uses the full packageName to protect against two sub-actions with the same",
        "   name that lives under different directories"
      ],
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["Kong/public-shared-actions/**"],
      "pinDigests": true,
      "groupName": "{{{packageName}}}"
    },
    {
      "description": [
        " Do not pin SLSA-GitHub-Generator by digest. The project publishes versioned tags and",
        " explicitly recommends disabling digest pinning for Renovate so updates track tags only.",
        " Pinning to a commit SHA can break provenance and reusability expectations of the generator",
        " and will fight with the upstream release /tag workflow",
        " More info: https://github.com/slsa-framework/slsa-github-generator/blob/main/RENOVATE.md"
      ],
      "matchManagers": ["github-actions"],
      "matchPackageNames": ["slsa-framework/slsa-github-generator"],
      "pinDigests": false
    },
    {
      "description": [
        " Ensure commit and PR titles use the full package name for better clarity. Prevent",
        " lowercase conversion of the package name to keep 'Kong' correctly capitalized. Set commit",
        " actions to use lowercase (e.g., 'update', 'pin', 'replace', 'roll back'). Also update",
        " the PR body table to reflect the full name"
      ],
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["Kong/public-shared-actions/**"],
      "commitMessageTopic": "{{{packageName}}}",
      "commitMessageLowerCase": "never",
      "commitMessageAction": "bump",
      "pin": {"commitMessageAction": "pin"},
      "pinDigest": {"commitMessageAction": "pin"},
      "replacement": {"commitMessageAction": "replace"},
      "rollback": {"commitMessageAction": "roll back"},
      "prBodyDefinitions": {
        "Package": "[{{{packageName}}}]({{{sourceUrl}}}){{#if newName}}{{#unless (equals depName newName)}} → {{{newNameLinked}}}{{/unless}}{{/if}}"
      }
    },
    {
      "description": [
        " Force-upgrade and pin for Kong/public-shared-actions sub-actions. This rule upgrades",
        " repositories using versions below 4 (e.g., v1 – v3) to the latest v4+ sub-action tag and",
        " automatically pins each reference to its commit digest. It is prioritized and always",
        " re-created until merged, bypassing normal schedules and Renovate rate limits so",
        " repositories get secure, updatable references immediately.",
        "",
        " Why: The monorepo now publishes per-sub-action tags in the form '<sub-action>@<version>'",
        " (e.g., 'workflow-notification@4.0.1') instead of plain 'vX.Y.Z' tags. Older references",
        " like '...@v2' cannot be auto-migrated by tag alone. Upgrading to v4+ plus digest pinning",
        " avoids tag-name mismatches because Renovate tracks updates by commit SHA and also annotates",
        " the line with a friendly '# vX.Y.Z' comment for humans"
      ],
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["Kong/public-shared-actions/**"],
      "matchCurrentValue": "/^v?[0-3](?:\\.[0-9]+){0,2}$/",
      "extends": [":disableRateLimiting", ":prImmediately"],
      "recreateWhen": "always",
      "schedule": ["at any time"],
      "minimumReleaseAge": null,
      "updateNotScheduled": true,
      "dependencyDashboardApproval": false,
      "prHeader": "> [!CAUTION]\n> This PR upgrades `Kong/public-shared-actions` sub-action to v4+ and pins it to the commit digest. It is prioritized (bypasses schedules/rate limits). Closing this PR will not stop it; Renovate will automatically reopen or recreate it until it is merged.\n\n---",
      "prBodyNotes": [
        "---\n> [!NOTE]\n> #### Mandatory upgrade to v4+ with automatic digest pinning for `Kong/public-shared-actions`\n>\n> Renovate is configured to upgrade any `Kong/public-shared-actions` sub-action still on versions below 4 to the latest v4+ version. As part of this upgrade, it will automatically pin each reference to the exact commit digest (and keep that digest refreshed over time).\n>\n> #### Background\n>\n> The `Kong/public-shared-actions` monorepo now publishes per-sub-action tags in the form `<sub-action>@<version>` (for example, `workflow-notification@4.0.1`) instead of plain `vX.Y.Z` tags. Older references like `...@v2` cannot be auto-migrated by tag alone.\n>\n> #### Why tag-only migration is not supported\n>\n> Important: Renovate will not change the tag format for you. Migrating from the older plain `vX.Y.Z` tags to the new per-sub-action tags while keeping tag-only references would require rewriting refs such as `...@v2` to a different tag name like `...@sca@5.1.1`. This contradicts the goal of dependency update automation because it relies on humans to manage tag-name changes and ongoing updates, which our automation is not designed to perform. For this reason, tag-only migration is not supported.\n>\n> Instead, this preset enforces digest pinning. Renovate resolves releases by tag, then writes the reference as the commit SHA for that release with a trailing human-friendly comment (e.g., `...@<sha> # v5.1.1`). Tracking commits rather than tag names keeps updates automated and robust even if tag naming conventions change.\n>\n> #### Security\n>\n> GitHub Actions security guidance recommends pinning third-party actions to a full commit SHA to protect against tag moving and supply-chain attacks.\n>\n> #### References\n>\n> - https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions"
      ]
    }
  ]
}
