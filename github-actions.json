{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "description": [
    " This preset provides a shared configuration for updating GitHub Actions. It adds a custom",
    " manager to handle action dependencies in selected repositories and includes general policy",
    " rules (such as digest pinning behavior). It also extends presets that map digests to semver",
    " versions"
  ],
  "extends": [
    "group:githubArtifactActions",
    "helpers:pinGitHubActionDigests",
    "helpers:pinGitHubActionDigestsToSemver",
    "Kong/public-shared-renovate:github-actions-changed-files"
  ],
  "customManagers": [
    {
      "description": [
        " Custom regex manager for sub-actions under 'Kong/public-shared-actions/**'. It operates",
        " in workflow/action YAML files such as:",
        "   - .github/workflows/*.yml",
        "   - workflow-templates/**",
        "   - action.yml",
        "",
        " Matching behavior",
        "   - Matches fully qualified action paths with any number of nested subpaths ending in",
        "     '@<ref>'",
        "   - <ref> can be a semver-like tag ('v1.2.3', '1.2.3', '7.8.9.10', 'v0.1.2-abc') or a",
        "     commit SHA (7-40 hex chars) used as a digest",
        "   - If pinned by digest, an optional inline comment may include the human-readable",
        "     version; whitespace before/after '#' is allowed. Examples: '# v1.2.3', '# 1.2.3',",
        "     or '#1.2.3'",
        "   - Versions support 1–4 numeric sections and optional prerelease/build parts with",
        "     hyphens/dots; an optional leading 'v' is allowed",
        "",
        " Version extraction (extractVersionTemplate) - examples",
        "   - @security-actions/sca@1.2.3",
        "   - @security-actions/scan-rust@v4.5.6",
        "   - security-actions/semgrep@7.8.9.10",
        "   - security-actions/lua-lint@v0.1.2-abc",
        "   - sca@7.8.9",
        "   - scan-rust@v0.1.2",
        "   - a/b/c/d/e/lua-lint@v3.4.5.6-abc.foo",
        "",
        " matchStrings - examples of full matches",
        "   # VALID",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3.4 # foo",
        "   - Kong/public-shared-actions/security-actions/sca@v1.2.3-abcd-a # bar",
        "   - Kong/public-shared-actions/a/b/c/d/e/f/sca@0928c369d5227de0ca35643d0e86949114384bd2",
        "   - Kong/public-shared-actions/sca@0928c369d5227de0ca35643d0e86949114384bd2 # v1.2.3",
        "   - Kong/public-shared-actions/sca@0928c36\t \t#\t\t 1.2.3",
        "   - Kong/public-shared-actions/sca@0928c369d#1.2.3",
        "",
        "   # INVALID",
        "   - foo/public-shared-actions/security-actions/sca@1.2.3",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3.4.5 # foo",
        "   - Kong/public-shared-actions/security-actions/sca@1.2.3_abcd-a # bar",
        "   - Kong/public-shared-actions/security-actions/sca@b1.2.3-abcd-a # bar",
        "   - Kong/public-shared-actions/a/b/c/d/e/f/g/1h/sca@0928c",
        "   - Kong/public-shared-actions/sca@0928c369d5227de0ca35643d0e86949114384bd2foo # v1.2.3",
        "   - Kong/public-shared-actions/sca@0928c36_2\t \t#\t\t 1.2.3",
        "   - Kong/public-shared-actions/sca@0928c369d5227de0ca35643d0e86949114384bd2##1.2.3",
        "",
        " Version lookup and replacement",
        "   - 'datasourceTemplate': Uses GitHub tags to find available releases for the action.",
        "     Renovate queries the 'Kong/public-shared-actions' repository's tags and, under",
        "     semver-coerced versioning, applies SemVer sorting after coercing tag names.",
        "     Updates track published tags like 'sca@1.2.3' rather than branches or release",
        "     assets",
        "   - 'autoReplaceStringTemplate': Defines how the matched reference is rewritten.",
        "     It keeps the full package path ('{{{packageName}}}') and replaces the '@<ref>' with:",
        "       - '@<newDigest> # v<newVersion>' when pinning by commit (adds a friendly version)",
        "       - '@<newVersion>'                when referencing by tag only",
        "     Examples:",
        "       - '@0928… # v1.2.3' -> '@abcd… # v1.2.4'",
        "       - '@1.2.3'          -> '@1.2.4'"
      ],
      "customType": "regex",
      "managerFilePatterns": [
        "/(^|/)(workflow-templates|\\.(?:github|gitea|forgejo)/(?:workflows|actions))/.+\\.ya?ml$/",
        "/(^|/)action\\.ya?ml$/"
      ],
      "matchStrings": [
        "(?<packageName>pankajkongorg\\/pankaj-public-shared-actions\\/(?:[0-9A-Za-z._-]*\\/)*(?<depName>[^\\s@]+))@(?:(?<currentDigest>[0-9A-Fa-f]{7,40})[\\t ]*#[\\t ]*)?v?(?<currentValue>(?:[0-9]+(?:\\.[0-9]+){0,3}(?:-[0-9A-Za-z.-]+)?|[0-9A-Fa-f]{7,40}))(?<indentation>\\s|$)"
      ],
      "datasourceTemplate": "github-tags",
      "extractVersionTemplate": "^@?(?:[0-9A-Za-z._-]*\\/)*{{{depName}}}[@_](?<version>v?(?:[0-9]+(?:\\.[0-9]+){0,3}(?:-[0-9A-Za-z.-]+)?))$",
      "autoReplaceStringTemplate": "{{{packageName}}}@{{#if newDigest}}{{{newDigest}}} # {{{prettyNewVersion}}}{{else}}{{{newValue}}}{{/if}}{{{indentation}}}",
      "versioningTemplate": "semver-coerced"
    }
  ],
  "packageRules": [
    {
      "description": [
        " Manage pankajkongorg/pankaj-public-shared-actions updates using the custom manager, so disable the default",
        " GitHub Actions manager for these"
      ],
      "matchPackageNames": ["pankajkongorg/pankaj-public-shared-actions"],
      "matchManagers": ["github-actions"],
      "enabled": false
    },
    {
      "description": [
        " Do not pin SLSA-GitHub-Generator by digest. The project publishes versioned tags and",
        " explicitly recommends disabling digest pinning for Renovate so updates track tags only.",
        " Pinning to a commit SHA can break provenance and reusability expectations of the generator",
        " and will fight with the upstream release /tag workflow",
        " More info: https://github.com/slsa-framework/slsa-github-generator/blob/main/RENOVATE.md"
      ],
      "matchManagers": ["github-actions"],
      "matchPackageNames": ["slsa-framework/slsa-github-generator"],
      "pinDigests": false
    },
    {
      "description": [
        " Disable digest updates only for actions that are versioned (i.e., have a tag), to avoid",
        " duplicate PRs-one for the digest and one for the version. Digest updates remain enabled",
        " for actions pinned solely by digest (e.g., to track master/main), which are not covered",
        " by our versioning rules"
      ],
      "matchCurrentValue": "/^[^.]+\\./",
      "matchUpdateTypes": "digest",
      "enabled": false
    },
    {
      "description": [
        " Ensure commit and PR titles use the full package name for better clarity. Prevent",
        " lowercase conversion of the package name to keep `Kong` correctly capitalized. Set commit",
        " actions to use lowercase (e.g., `update`, `pin`, `replace`, `roll back`). Also update",
        " the PR body table to reflect the full name and include a link to the source code"
      ],
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["pankajkongorg/pankaj-public-shared-actions/**"],
      "commitMessageTopic": "{{{packageName}}}",
      "commitMessageLowerCase": "never",
      "commitMessageAction": "bump",
      "pin": {"commitMessageAction": "pin"},
      "pinDigest": {"commitMessageAction": "pin"},
      "replacement": {"commitMessageAction": "replace"},
      "rollback": {"commitMessageAction": "roll back"},
      "prBodyDefinitions": {
        "Package": "[{{{packageName}}}]({{{sourceUrl}}}) ([source]({{{sourceUrl}}}/tree/{{#if newVersion}}%40{{{depName}}}%40{{{newVersion}}}{{else}}{{#if newDigest}}{{{newDigest}}}{{else}}main{{/if}}{{/if}}/{{{depName}}}))"
      }
    },
    {
      "description": [
        " Enforce digest pinning for Kong/public-shared-actions sub-actions. This rule prioritizes",
        " and always recreates PRs that pin or refresh commit digests for these actions, bypassing",
        " normal schedules and Renovate rate limits so repositories get secure, updatable references",
        " immediately",
        "",
        " Why: This monorepo now publishes per-sub-action tags like '<name>@<version>'",
        " (e.g., 'workflow-notification@4.0.1') rather than simple 'vX.Y.Z' tags. Repositories",
        " using '...@v2' cannot be auto-migrated to the new tag names without changing",
        " the reference format (which would look like '...@workflow-notification@4.0.1'). Digest",
        " pinning avoids the tag-name mismatch entirely because Renovate tracks and updates",
        " by commit SHA and adds a friendly '# vX.Y.Z' comment for humans"
      ],
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["pankajkongorg/pankaj-public-shared-actions/**"],
      "matchUpdateTypes": ["pinDigest"],
      "extends": [":disableRateLimiting", ":prImmediately"],
      "recreateWhen": "always",
      "schedule": [],
      "prHeader": "> [!CAUTION]\\n> This PR pins Kong/public-shared-actions to commit digests and is prioritized (bypasses schedules/rate limits). It will be re-created until merged.",
      "prBodyNotes": [
        "> [!NOTE] Why digest pinning is required for Kong/public-shared-actions",
        "> Kong/public-shared-actions changed release tagging: sub-actions are released with tags in the form '<sub-action-name>@<version>' (not plain 'vX.Y.Z').",
        "> For example, projects that used '.../slack-actions/workflow-notification@v2' and any other sub-actions previously referenced with plain version tags like 'vX...' or 'X...' cannot be auto-updated by tag alone, because the correct tag is 'workflow-notification@4.0.1', which would require '.../workflow-notification@workflow-notification@4.0.1'.",
        "> With digest pinning, Renovate looks up the tag and records its commit SHA, so the tag name shape no longer matters.",
        "> Example (safe form):",
        "> ```yaml",
        "> uses: Kong/public-shared-actions/slack-actions/workflow-notification@a18abf762d6e2444bcbfd20de70451ea1e3bc1b1 # v4.0.1",
        "> ```",
        "> This is safe and recommended: GitHub Actions security guidance advises pinning third-party actions to a full commit SHA to protect against tag moving and supply-chain attacks.",
        "> References: GitHub Docs (Security hardening, pin to commit SHA): https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions"
      ]
    }
  ]
}
